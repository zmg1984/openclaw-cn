name: Upstream Release Monitor
# ç›‘å¬ä¸Šæ¸¸ openclaw/openclaw çš„æ–° Release å‘å¸ƒ
# ä½¿ç”¨ AI Agent åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶åˆ°æœ¬ fork

on:
  schedule:
    # æ¯å¤© UTC 08:00ï¼ˆåŒ—äº¬æ—¶é—´ 16:00ï¼‰æ£€æŸ¥ä¸Šæ¸¸æ–° Release
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼ºåˆ¶æ£€æŸ¥æ‰€æœ‰æœªå¤„ç†çš„ä¸Šæ¸¸ Release'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

env:
  UPSTREAM_REPO: "openclaw/openclaw"
  CHECKLIST_FILE: "UPSTREAM_MERGE_CHECKLIST.md"
  # æŒä¹…åŒ–æ ‡è®°æ–‡ä»¶ï¼Œè®°å½•å·²å¤„ç†çš„æœ€æ–°ä¸Šæ¸¸ç‰ˆæœ¬
  LAST_TAG_FILE: ".github/last-upstream-tag"

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_new_releases: ${{ steps.check.outputs.has_new }}
      new_releases: ${{ steps.check.outputs.releases }}
      latest_tag: ${{ steps.check.outputs.latest_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Get last checked release tag
        id: last_checked
        run: |
          # ä¼˜å…ˆä»æ ‡è®°æ–‡ä»¶è¯»å–å·²å¤„ç†çš„æœ€æ–°ç‰ˆæœ¬
          if [ -f "$LAST_TAG_FILE" ]; then
            LAST_TAG=$(cat "$LAST_TAG_FILE" | tr -d '[:space:]')
          fi
          # å›é€€ï¼šä»æ¸…å•æ–‡ä»¶æå–
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG=$(grep -oE 'v2026\.[0-9]+\.[0-9]+(-[0-9]+)?' "$CHECKLIST_FILE" 2>/dev/null | sort -V | tail -1)
          fi
          echo "last_tag=${LAST_TAG:-v2026.1.29}" >> "$GITHUB_OUTPUT"
          echo "Last checked upstream tag: ${LAST_TAG:-v2026.1.29}"

      - name: Check for new upstream releases
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST_TAG="${{ steps.last_checked.outputs.last_tag }}"
          echo "Checking for releases newer than $LAST_TAG..."

          # è·å–ä¸Šæ¸¸æ‰€æœ‰ Release
          RELEASES=$(gh api "repos/$UPSTREAM_REPO/releases" --paginate \
            --jq "[.[] | select(.tag_name > \"$LAST_TAG\" and .draft == false and .prerelease == false) | {tag: .tag_name, date: .published_at, body: .body}]")

          COUNT=$(echo "$RELEASES" | jq 'length')
          echo "Found $COUNT new release(s)"

          if [ "$COUNT" -gt 0 ]; then
            echo "has_new=true" >> "$GITHUB_OUTPUT"
            # è®°å½•æœ¬æ‰¹æ¬¡æœ€æ–°çš„ tagï¼Œç”¨äºåç»­æ›´æ–°æ ‡è®°æ–‡ä»¶
            LATEST=$(echo "$RELEASES" | jq -r '[.[].tag] | sort_by(.) | last')
            echo "latest_tag=$LATEST" >> "$GITHUB_OUTPUT"
            echo "Latest tag in batch: $LATEST"
            # ä¿å­˜ release æ•°æ®ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "$RELEASES" > /tmp/new-releases.json
            echo "releases<<RELEASES_EOF" >> "$GITHUB_OUTPUT"
            cat /tmp/new-releases.json >> "$GITHUB_OUTPUT"
            echo "RELEASES_EOF" >> "$GITHUB_OUTPUT"
          else
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          fi

  analyze-releases:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_new_releases == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Save release data
        run: |
          cat << 'RELEASES_JSON' > /tmp/new-releases.json
          ${{ needs.check-upstream.outputs.new_releases }}
          RELEASES_JSON

      - name: Analyze with AI Agent
        id: analyze
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          # æ”¯æŒçš„ä¾›åº”å•†: deepseek (æ¨è), siliconflow, zhipu, moonshot, qwen, openai, anthropic
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'deepseek' }}
          # å¯é€‰ï¼šè‡ªå®šä¹‰ API base URLï¼ˆè¦†ç›–ä¾›åº”å•†é»˜è®¤å€¼ï¼‰
          AI_BASE_URL: ${{ vars.AI_BASE_URL || '' }}
          # å¯é€‰ï¼šè‡ªå®šä¹‰æ¨¡å‹åç§°ï¼ˆè¦†ç›–ä¾›åº”å•†é»˜è®¤å€¼ï¼‰
          AI_MODEL: ${{ vars.AI_MODEL || '' }}
        run: |
          # æå– release notes çš„æ¯ä¸€æ¡å˜æ›´
          RELEASE_BODY=$(cat /tmp/new-releases.json | jq -r '.[].body')

          # æ ¹æ®ä¾›åº”å•†è®¾ç½® API å‚æ•°
          case "$AI_PROVIDER" in
            deepseek)
              BASE_URL="${AI_BASE_URL:-https://api.deepseek.com/v1}"
              MODEL="${AI_MODEL:-deepseek-chat}"
              ;;
            siliconflow)
              BASE_URL="${AI_BASE_URL:-https://api.siliconflow.cn/v1}"
              MODEL="${AI_MODEL:-deepseek-ai/DeepSeek-V3}"
              ;;
            moonshot)
              BASE_URL="${AI_BASE_URL:-https://api.moonshot.cn/v1}"
              MODEL="${AI_MODEL:-moonshot-v1-128k}"
              ;;
            qwen)
              BASE_URL="${AI_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}"
              MODEL="${AI_MODEL:-qwen-max}"
              ;;
            zhipu)
              BASE_URL="${AI_BASE_URL:-https://open.bigmodel.cn/api/paas/v4}"
              MODEL="${AI_MODEL:-glm-4-plus}"
              ;;
            openai)
              BASE_URL="${AI_BASE_URL:-https://api.openai.com/v1}"
              MODEL="${AI_MODEL:-gpt-4o}"
              ;;
            anthropic)
              BASE_URL="${AI_BASE_URL:-https://api.anthropic.com}"
              MODEL="${AI_MODEL:-claude-sonnet-4-20250514}"
              ;;
            *)
              # è‡ªå®šä¹‰ OpenAI å…¼å®¹ä¾›åº”å•†
              BASE_URL="${AI_BASE_URL}"
              MODEL="${AI_MODEL:-gpt-4o}"
              ;;
          esac

          echo "Using provider: $AI_PROVIDER, model: $MODEL, base: $BASE_URL"

          # æ„é€  AI prompt
          cat << 'PROMPT_EOF' > /tmp/analysis-prompt.txt
          ä½ æ˜¯ä¸€ä¸ªä»£ç åˆå¹¶åˆ†æ Agentã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æä¸Šæ¸¸ openclaw/openclaw é¡¹ç›®çš„ Release å˜æ›´ï¼Œ
          åˆ¤æ–­å“ªäº›éœ€è¦åˆå¹¶åˆ° openclaw-cnï¼ˆä¸­æ–‡æœ¬åœ°åŒ– forkï¼‰ã€‚

          ## åˆå¹¶åˆ¤æ–­è§„åˆ™

          ### å¿…é¡»åˆå¹¶ï¼ˆè®¾ä¸º MERGEï¼‰:
          1. æ‰€æœ‰å®‰å…¨ä¿®å¤ï¼ˆSecurity/SSRF/XSS/injection/traversal/auth/CSRF ç›¸å…³ï¼‰
          2. æ ¸å¿ƒå¼•æ“ bug ä¿®å¤ï¼ˆGateway/Sessions/Agents/Cron/Heartbeat/Compactionï¼‰
          3. å†…å­˜æ³„æ¼/èµ„æºæ³„æ¼ä¿®å¤
          4. ä¸­å›½ç›¸å…³ Provider æ”¯æŒï¼ˆMoonshot/æ™ºè°±/MiniMax/ç«å±±å¼•æ“/é€šä¹‰åƒé—®ç­‰ï¼‰
          5. ä½¿ç”¨ä¸­æ¸ é“çš„ bug ä¿®å¤ï¼šTelegramã€Discordã€WhatsAppã€Slackã€Signalã€é£ä¹¦/Feishuã€Web UIã€TUI
          6. æ–°æ¨¡å‹æ”¯æŒï¼ˆOpus/Codex/GLM ç­‰ï¼‰
          7. QMD è®°å¿†ç³»ç»Ÿä¿®å¤ï¼ˆéœ€æ ‡æ³¨"éœ€å¯¹æ¯”æœ¬åœ°å®ç°"ï¼‰
          8. æµå¼è¾“å‡ºä¿®å¤
          9. Config/é…ç½®ç³»ç»Ÿä¿®å¤
          10. CJK/Unicode/ä¸­æ–‡ç›¸å…³ä¿®å¤

          ### å¯é€‰åˆå¹¶ï¼ˆè®¾ä¸º OPTIONALï¼‰:
          1. æ–°åŠŸèƒ½å¢å¼ºï¼ˆWeb UI æ–°ç•Œé¢ç­‰ï¼‰
          2. æ–‡æ¡£æ›´æ–°
          3. CLI æ”¹å–„
          4. éå…³é”®çš„ UI è°ƒæ•´
          5. æµ‹è¯•æ”¹è¿›

          ### è·³è¿‡ï¼ˆè®¾ä¸º SKIPï¼‰:
          1. æœªä½¿ç”¨æ¸ é“çš„ä¿®å¤ï¼šBlueBubblesã€Tlonã€Nostrã€MS Teamsã€Twitchã€Google Chatã€iMessageã€Mattermostã€Nextcloud Talkã€Line
          2. iOS/Android åŸç”Ÿåº”ç”¨ä¿®æ”¹
          3. macOS åº”ç”¨ä¸“å±ä¿®æ”¹ï¼ˆé™¤éæ¶‰åŠ CJK/ä¸­æ–‡ï¼‰
          4. CI/CD æµæ°´çº¿ä¿®æ”¹
          5. çº¯æµ‹è¯•ä»£ç ï¼ˆé™¤éä¿®å¤äº†ä½¿ç”¨ä¸­æ¸ é“çš„æµ‹è¯•ï¼‰

          ## è¾“å‡ºæ ¼å¼

          å¯¹æ¯æ¡å˜æ›´è¾“å‡ºä¸€è¡Œ JSONï¼š
          ```json
          {"action": "MERGE|OPTIONAL|SKIP", "priority": "P0|P1|P2|P3|P4|P5", "pr": "#XXXX", "release": "v2026.X.X", "description": "...", "category": "SECURITY|CRITICAL-BUG|CORE-FEATURE|MODEL|CHANNEL-FIX|NICE-TO-HAVE", "notes": "...", "conflict_risk": "LOW|MEDIUM|HIGH"}
          ```

          ## ä¸Šæ¸¸ Release Notes

          PROMPT_EOF

          echo "$RELEASE_BODY" >> /tmp/analysis-prompt.txt

          # è°ƒç”¨ AI APIï¼ˆæ‰€æœ‰ä¸­å›½ä¾›åº”å•†å‡å…¼å®¹ OpenAI æ ¼å¼ï¼‰
          if [ "$AI_PROVIDER" = "anthropic" ]; then
            RESPONSE=$(curl -s "${BASE_URL}/v1/messages" \
              -H "Content-Type: application/json" \
              -H "x-api-key: $AI_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "$(jq -n --arg model "$MODEL" --arg prompt "$(cat /tmp/analysis-prompt.txt)" '{
                model: $model,
                max_tokens: 8192,
                messages: [{role: "user", content: $prompt}]
              }')" | jq -r '.content[0].text')
          else
            # OpenAI å…¼å®¹æ ¼å¼ï¼ˆDeepSeek/SiliconFlow/Moonshot/Qwen/æ™ºè°±/OpenAI é€šç”¨ï¼‰
            RESPONSE=$(curl -s "${BASE_URL}/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $AI_API_KEY" \
              -d "$(jq -n --arg model "$MODEL" --arg prompt "$(cat /tmp/analysis-prompt.txt)" '{
                model: $model,
                messages: [{role: "user", content: $prompt}],
                max_tokens: 8192,
                temperature: 0.1
              }')" | jq -r '.choices[0].message.content')
          fi

          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            echo "::error::AI API call failed. Check AI_API_KEY and AI_PROVIDER settings."
            exit 1
          fi

          echo "$RESPONSE" > /tmp/analysis-result.txt
          echo "Analysis complete (${#RESPONSE} chars)"

      - name: Update checklist
        run: |
          # è§£æ AI åˆ†æç»“æœï¼Œè¿½åŠ åˆ°æ¸…å•æ–‡ä»¶
          RESULT=$(cat /tmp/analysis-result.txt)

          # æå–æ‰€æœ‰ MERGE å’Œ OPTIONAL æ¡ç›®
          MERGE_ITEMS=$(echo "$RESULT" | grep -o '{.*}' | jq -c 'select(.action == "MERGE" or .action == "OPTIONAL")' 2>/dev/null || true)

          if [ -z "$MERGE_ITEMS" ]; then
            echo "No new items to merge"
            exit 0
          fi

          # è·å–å½“å‰æ—¥æœŸ
          TODAY=$(date +%Y-%m-%d)

          # è¿½åŠ æ–°å‘ç°çš„æ¡ç›®åˆ°æ¸…å•
          {
            echo ""
            echo "---"
            echo ""
            echo "## è‡ªåŠ¨æ‰«ææ–°å¢æ¡ç›® ($TODAY)"
            echo ""
            echo "| çŠ¶æ€ | ä¼˜å…ˆçº§ | ä¸Šæ¸¸ PR | Release | æè¿° | ç±»åˆ« | å†²çªé£é™© | å¤‡æ³¨ |"
            echo "|------|--------|---------|---------|------|------|----------|------|"

            echo "$MERGE_ITEMS" | while IFS= read -r item; do
              ACTION=$(echo "$item" | jq -r '.action')
              PRIORITY=$(echo "$item" | jq -r '.priority')
              PR=$(echo "$item" | jq -r '.pr')
              RELEASE=$(echo "$item" | jq -r '.release')
              DESC=$(echo "$item" | jq -r '.description')
              CATEGORY=$(echo "$item" | jq -r '.category')
              RISK=$(echo "$item" | jq -r '.conflict_risk')
              NOTES=$(echo "$item" | jq -r '.notes')
              STATUS="â¬œ"
              [ "$ACTION" = "OPTIONAL" ] && STATUS="ğŸ”²"
              echo "| $STATUS | $PRIORITY | $PR | $RELEASE | $DESC | $CATEGORY | $RISK | $NOTES |"
            done
          } >> "$CHECKLIST_FILE"

      - name: Update last checked tag and commit
        env:
          LATEST_TAG: ${{ needs.check-upstream.outputs.latest_tag }}
        run: |
          git config user.name "upstream-monitor[bot]"
          git config user.email "bot@openclaw-cn.dev"

          # æ— è®ºåˆ†æç»“æœå¦‚ä½•ï¼Œéƒ½æ›´æ–°æ ‡è®°æ–‡ä»¶ä»¥é¿å…é‡å¤æ£€æµ‹
          mkdir -p "$(dirname "$LAST_TAG_FILE")"
          echo "$LATEST_TAG" > "$LAST_TAG_FILE"

          git add "$CHECKLIST_FILE" "$LAST_TAG_FILE"

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          TAGS=$(cat /tmp/new-releases.json | jq -r '[.[].tag] | join(", ")')
          git commit -m "chore: update upstream merge checklist ($TAGS)"
          git push

      - name: Create summary issue (deduplicated)
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAGS=$(cat /tmp/new-releases.json | jq -r '[.[].tag] | join(", ")')

          # å»é‡ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒ…å«ç›¸åŒ release æ ‡ç­¾çš„ open issue
          # ç”¨ç¬¬ä¸€ä¸ª tag ä½œä¸ºæœç´¢å…³é”®è¯ï¼ˆåŒä¸€æ‰¹ release çš„ issue æ ‡é¢˜åŒ…å«æ‰€æœ‰ tagsï¼‰
          FIRST_TAG=$(cat /tmp/new-releases.json | jq -r '.[0].tag')
          EXISTING=$(gh issue list --label "upstream" --state open --search "$FIRST_TAG in:title" --json number --jq 'length')

          if [ "$EXISTING" -gt 0 ]; then
            echo "Issue already exists for release $FIRST_TAG, skipping creation"
            exit 0
          fi

          MERGE_COUNT=$(grep -c 'â¬œ' "$CHECKLIST_FILE" 2>/dev/null || echo "0")
          OPTIONAL_COUNT=$(grep -c 'ğŸ”²' "$CHECKLIST_FILE" 2>/dev/null || echo "0")

          if [ "$MERGE_COUNT" -gt 0 ] || [ "$OPTIONAL_COUNT" -gt 0 ]; then
            printf '%s\n' \
              "## ä¸Šæ¸¸æ–° Release åˆ†æ" \
              "" \
              "ä¸Šæ¸¸å‘å¸ƒäº†æ–°ç‰ˆæœ¬: **$TAGS**" \
              "" \
              "### è‡ªåŠ¨åˆ†æç»“æœ" \
              "- ğŸ”´ éœ€è¦åˆå¹¶: **${MERGE_COUNT}** é¡¹" \
              "- ğŸ”µ å¯é€‰åˆå¹¶: **${OPTIONAL_COUNT}** é¡¹" \
              "" \
              "### ä¸‹ä¸€æ­¥" \
              "1. æŸ¥çœ‹ [UPSTREAM_MERGE_CHECKLIST.md](../blob/main/UPSTREAM_MERGE_CHECKLIST.md) ä¸­æ–°å¢çš„æ¡ç›®" \
              "2. ä½¿ç”¨ AI Agent é€æ¡å¤„ç†åˆå¹¶" \
              "3. å¤„ç†å®Œæˆåæ ‡è®° âœ…" \
              "" \
              "### ä¼˜å…ˆçº§å»ºè®®" \
              "ä¼˜å…ˆå¤„ç† P0 (å®‰å…¨) å’Œ P1 (å…³é”®ä¿®å¤) æ¡ç›®ã€‚" \
              > /tmp/issue-body.md

            # ç¡®ä¿ label å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
            gh label create upstream --description "ä¸Šæ¸¸å˜æ›´è¿½è¸ª" --color "0075ca" 2>/dev/null || true
            gh label create merge-needed --description "éœ€è¦åˆå¹¶çš„ä¸Šæ¸¸å˜æ›´" --color "d93f0b" 2>/dev/null || true

            gh issue create \
              --title "ä¸Šæ¸¸æ›´æ–°: $TAGS - ${MERGE_COUNT} é¡¹éœ€åˆå¹¶, ${OPTIONAL_COUNT} é¡¹å¯é€‰" \
              --body-file /tmp/issue-body.md \
              --label "upstream,merge-needed"
          fi
