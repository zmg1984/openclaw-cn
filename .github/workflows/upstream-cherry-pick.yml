name: Upstream Cherry-Pick
# ä»Žä¸Šæ¸¸ cherry-pick æŒ‡å®šä¼˜å…ˆçº§çš„ä¿®å¤åˆ°æœ¬ fork
# æ”¯æŒ: æ‰‹åŠ¨è§¦å‘ / upstream-monitor è‡ªåŠ¨è°ƒç”¨

on:
  workflow_dispatch:
    inputs:
      from_tag:
        description: 'èµ·å§‹ç‰ˆæœ¬ (auto = ä»Ž last-upstream-tag è‡ªåŠ¨è¯»å–)'
        type: string
        default: 'auto'
      to_tag:
        description: 'ç›®æ ‡ç‰ˆæœ¬ (latest = ä¸Šæ¸¸æœ€æ–° tag)'
        type: string
        default: 'latest'
      priority:
        description: 'åˆå¹¶ä¼˜å…ˆçº§'
        type: choice
        options:
          - 'P0'
          - 'P0,P1'
          - 'P0,P1,P2'
        default: 'P0,P1'
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸æ‰§è¡Œ'
        type: boolean
        default: true
      skip_build:
        description: 'è·³è¿‡æž„å»ºéªŒè¯ (PR CI ä¼šéªŒè¯)'
        type: boolean
        default: false
      issue_number:
        description: 'å…³è” Issue ç¼–å· (å¯é€‰ï¼Œç”¨äºŽç»“æžœå›žæŠ¥)'
        type: string
        default: ''

  # è¢« upstream-monitor è‡ªåŠ¨è°ƒç”¨
  workflow_call:
    inputs:
      from_tag:
        type: string
        default: 'auto'
      to_tag:
        type: string
        default: 'latest'
      priority:
        type: string
        default: 'P0,P1'
      dry_run:
        type: boolean
        default: false
      skip_build:
        type: boolean
        default: true
      issue_number:
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  cherry-pick:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup upstream remote
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git 2>/dev/null || true
          git fetch upstream --tags --force
          git fetch upstream main

      - name: Resolve tags
        id: tags
        run: |
          FROM="${{ inputs.from_tag }}"
          TO="${{ inputs.to_tag }}"

          # è‡ªåŠ¨è§£æž from_tag
          if [ "$FROM" = "auto" ] || [ -z "$FROM" ]; then
            if [ -f ".github/last-upstream-tag" ]; then
              FROM=$(cat .github/last-upstream-tag | tr -d '[:space:]')
              echo "Auto-resolved from_tag: $FROM"
            else
              echo "::error::No .github/last-upstream-tag file found. Please specify from_tag manually."
              exit 1
            fi
          fi

          # è‡ªåŠ¨è§£æž to_tag
          if [ "$TO" = "latest" ] || [ -z "$TO" ]; then
            TO=$(git tag -l 'v*' --sort=-version:refname | grep -v '-' | head -1)
            echo "Auto-resolved to_tag: $TO"
          fi

          if [ "$FROM" = "$TO" ]; then
            echo "from_tag == to_tag ($FROM), nothing to do"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "from=$FROM" >> "$GITHUB_OUTPUT"
          echo "to=$TO" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Range: $FROM â†’ $TO"

      - name: Extract commits
        if: steps.tags.outputs.skip != 'true'
        run: |
          chmod +x scripts/upstream-extract-commits.sh
          ./scripts/upstream-extract-commits.sh \
            "${{ steps.tags.outputs.from }}" \
            "${{ steps.tags.outputs.to }}" \
            > /tmp/extract-result.json 2>/tmp/extract.log
          cat /tmp/extract.log

          echo "=== æå–æ‘˜è¦ ==="
          jq -r 'group_by(.action) | .[] | "\(.[0].action): \(length) ä¸ª"' /tmp/extract-result.json

      - name: Preview changes
        if: inputs.dry_run && steps.tags.outputs.skip != 'true'
        run: |
          P_FILTER=$(echo "${{ inputs.priority }}" | tr ',' '|')
          {
            echo "## ðŸ” é¢„è§ˆ: ${{ steps.tags.outputs.from }} â†’ ${{ steps.tags.outputs.to }}"
            echo ""
            echo "### ç­›é€‰ä¼˜å…ˆçº§: ${{ inputs.priority }}"
            echo ""
            echo "| ä¼˜å…ˆçº§ | Commit | æè¿° | ç±»åˆ« | é£Žé™© |"
            echo "|--------|--------|------|------|------|"
            jq -r --arg p "$P_FILTER" \
              '.[] | select(.action == "MERGE" and (.priority | test("^(\($p))$"))) |
              "| \(.priority) | `\(.sha[:10])` | \(.message) | \(.category) | \(.conflict_risk) |"' \
              /tmp/extract-result.json
            echo ""
            TOTAL=$(jq --arg p "$P_FILTER" \
              '[.[] | select(.action == "MERGE" and (.priority | test("^(\($p))$")))] | length' \
              /tmp/extract-result.json)
            echo "**æ€»è®¡: $TOTAL ä¸ª commit å¾… cherry-pick**"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Execute cherry-pick
        if: ${{ !inputs.dry_run && steps.tags.outputs.skip != 'true' }}
        id: pick
        run: |
          git config user.name "upstream-merge[bot]"
          git config user.email "bot@openclaw-cn.dev"

          chmod +x scripts/upstream-cherry-pick.sh

          ARGS="--map /tmp/extract-result.json --priority ${{ inputs.priority }}"
          if [ "${{ inputs.skip_build }}" = "true" ]; then
            ARGS="$ARGS --skip-build"
          fi

          ./scripts/upstream-cherry-pick.sh $ARGS 2>&1 | tee /tmp/cherry-pick.log

          # æ”¶é›†ç»“æžœ
          BRANCH=$(git branch --show-current)
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          if [[ "$BRANCH" == upstream-cherry-pick/* ]]; then
            COUNT=$(git rev-list main.."$BRANCH" --count 2>/dev/null || echo "0")
            echo "commit_count=$COUNT" >> "$GITHUB_OUTPUT"
            echo "has_commits=$( [ "$COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          else
            echo "commit_count=0" >> "$GITHUB_OUTPUT"
            echo "has_commits=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: ${{ !inputs.dry_run && steps.pick.outputs.has_commits == 'true' }}
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.pick.outputs.branch }}"
          FROM="${{ steps.tags.outputs.from }}"
          TO="${{ steps.tags.outputs.to }}"
          PRIORITY="${{ inputs.priority }}"
          COUNT="${{ steps.pick.outputs.commit_count }}"

          git push -u origin "$BRANCH"

          {
            echo "## ä¸Šæ¸¸ Cherry-Pick: $FROM â†’ $TO"
            echo ""
            echo "### åˆå¹¶å†…å®¹"
            echo "- ä¼˜å…ˆçº§: **$PRIORITY**"
            echo "- æˆåŠŸ cherry-pick: **$COUNT** ä¸ª commit"
            echo ""
            echo "### Cherry-pick æ—¥å¿— (æœ€åŽ 30 è¡Œ)"
            echo '```'
            tail -30 /tmp/cherry-pick.log
            echo '```'
            echo ""
            echo "### æ£€æŸ¥é¡¹"
            echo "- [ ] æž„å»ºé€šè¿‡"
            echo "- [ ] æµ‹è¯•é€šè¿‡"
            echo "- [ ] CN å®šåˆ¶æœªè¢«è¦†ç›– (package.json, docs/, feishu/)"
          } > /tmp/pr-body.md

          gh label create upstream --color "0075ca" 2>/dev/null || true

          PR_URL=$(gh pr create \
            --title "chore: upstream cherry-pick $PRIORITY ($FROM â†’ $TO)" \
            --body-file /tmp/pr-body.md \
            --label "upstream" \
            --base main)

          PR_NUM=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Created PR #$PR_NUM"

      - name: Report results to Issue
        if: ${{ !inputs.dry_run && inputs.issue_number != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE="${{ inputs.issue_number }}"
          PR_NUM="${{ steps.pr.outputs.pr_number }}"
          COUNT="${{ steps.pick.outputs.commit_count }}"

          {
            echo "## ðŸ¤– è‡ªåŠ¨ Cherry-Pick å®Œæˆ"
            echo ""
            if [ -n "$PR_NUM" ]; then
              echo "âœ… **PR: #$PR_NUM**"
              echo "- æˆåŠŸåˆå…¥: **$COUNT** ä¸ª commit"
            else
              echo "â„¹ï¸ æœªåˆ›å»º PR â€” æ‰€æœ‰ commit å·²è¢«è·³è¿‡æˆ–å­˜åœ¨å†²çª"
            fi
            echo ""

            # æå–æˆåŠŸ/å¤±è´¥/è·³è¿‡æ•°
            SUCCESS=$(grep -oP 'âœ… æˆåŠŸ: \K[0-9]+' /tmp/cherry-pick.log 2>/dev/null || echo "0")
            FAILED=$(grep -oP 'âŒ å¤±è´¥: \K[0-9]+' /tmp/cherry-pick.log 2>/dev/null || echo "0")
            SKIPPED=$(grep -oP 'â­ï¸  è·³è¿‡: \K[0-9]+' /tmp/cherry-pick.log 2>/dev/null || echo "0")

            echo "| ç»“æžœ | æ•°é‡ |"
            echo "|------|------|"
            echo "| âœ… æˆåŠŸ | $SUCCESS |"
            echo "| âŒ å†²çª | $FAILED |"
            echo "| â­ï¸ è·³è¿‡ (æœ¬åœ°ä¿æŠ¤) | $SKIPPED |"
            echo ""

            if [ "$FAILED" -gt 0 ]; then
              echo "### âš ï¸ éœ€æ‰‹åŠ¨å¤„ç†çš„ commit"
              echo ""
              echo '```bash'
              grep 'git cherry-pick' /tmp/cherry-pick.log 2>/dev/null || echo "# è¯·æŸ¥çœ‹ Actions æ—¥å¿—èŽ·å–è¯¦æƒ…"
              echo '```'
            fi
          } > /tmp/issue-comment.md

          gh issue comment "$ISSUE" --body-file /tmp/issue-comment.md
          echo "Commented on issue #$ISSUE"
